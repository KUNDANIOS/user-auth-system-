// Add this JavaScript to your index.html file
// Make sure to use the correct API endpoints that match your server.js

// ==================== REGISTER/SIGNUP ====================
async function handleSignup() {
    const username = document.getElementById('signupUsername').value;
    const email = document.getElementById('signupEmail').value;
    const password = document.getElementById('signupPassword').value;

    try {
        const response = await fetch('/api/auth/signup', {  // Correct endpoint
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ username, email, password })
        });

        const result = await response.json();
        
        if (result.success) {
            // Save token and user data
            localStorage.setItem('authToken', result.data.token);
            localStorage.setItem('userData', JSON.stringify({
                userId: result.data.userId,
                username: result.data.username,
                email: result.data.email
            }));
            
            alert('Registration successful!');
            showDashboard();
        } else {
            alert(result.message || 'Registration failed');
        }
    } catch (error) {
        console.error('Signup error:', error);
        alert('Network error. Please try again.');
    }
}

// ==================== LOGIN ====================
async function handleLogin() {
    const emailOrUsername = document.getElementById('loginUsername').value;
    const password = document.getElementById('loginPassword').value;

    try {
        const response = await fetch('/api/auth/login', {  // Correct endpoint
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ emailOrUsername, password })  // Note: emailOrUsername, not just username
        });

        const result = await response.json();
        
        if (result.success) {
            // Save token and user data
            localStorage.setItem('authToken', result.data.token);
            localStorage.setItem('userData', JSON.stringify({
                userId: result.data.userId,
                username: result.data.username,
                email: result.data.email
            }));
            
            alert('Login successful!');
            showDashboard();
        } else {
            alert(result.message || 'Login failed');
        }
    } catch (error) {
        console.error('Login error:', error);
        alert('Network error. Please try again.');
    }
}

// ==================== GET USER PROFILE ====================
async function loadUserProfile() {
    const token = localStorage.getItem('authToken');
    
    if (!token) {
        showLoginForm();
        return;
    }

    try {
        const response = await fetch('/api/user/profile', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        const result = await response.json();
        
        if (result.success) {
            displayUserProfile(result.data);
        } else {
            if (response.status === 401) {
                // Token expired or invalid
                localStorage.removeItem('authToken');
                localStorage.removeItem('userData');
                alert('Session expired. Please login again.');
                showLoginForm();
            } else {
                alert(result.message || 'Failed to load profile');
            }
        }
    } catch (error) {
        console.error('Profile load error:', error);
        alert('Network error. Please try again.');
    }
}

// ==================== UPDATE PROFILE ====================
async function updateProfile() {
    const token = localStorage.getItem('authToken');
    const newUsername = document.getElementById('newUsername').value;
    
    if (!token) {
        showLoginForm();
        return;
    }

    try {
        const response = await fetch('/api/user/profile', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ username: newUsername })
        });

        const result = await response.json();
        
        if (result.success) {
            // Update stored user data
            localStorage.setItem('userData', JSON.stringify(result.data));
            alert('Profile updated successfully!');
            loadUserProfile();
        } else {
            alert(result.message || 'Update failed');
        }
    } catch (error) {
        console.error('Update error:', error);
        alert('Network error. Please try again.');
    }
}

// ==================== DELETE ACCOUNT ====================
async function deleteAccount() {
    if (!confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
        return;
    }

    const token = localStorage.getItem('authToken');
    
    if (!token) {
        showLoginForm();
        return;
    }

    try {
        const response = await fetch('/api/user/profile', {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        const result = await response.json();
        
        if (result.success) {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userData');
            alert('Account deleted successfully');
            showLoginForm();
        } else {
            alert(result.message || 'Deletion failed');
        }
    } catch (error) {
        console.error('Delete error:', error);
        alert('Network error. Please try again.');
    }
}

// ==================== LOGOUT ====================
function handleLogout() {
    localStorage.removeItem('authToken');
    localStorage.removeItem('userData');
    showLoginForm();
}

// ==================== REFRESH TOKEN ====================
async function refreshToken() {
    const token = localStorage.getItem('authToken');
    
    if (!token) return;

    try {
        const response = await fetch('/api/auth/refresh', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        const result = await response.json();
        
        if (result.success) {
            localStorage.setItem('authToken', result.data.token);
        }
    } catch (error) {
        console.error('Token refresh error:', error);
    }
}

// ==================== HELPER FUNCTIONS ====================
function showLoginForm() {
    // Your code to show login form
    document.getElementById('loginForm').style.display = 'block';
    document.getElementById('signupForm').style.display = 'none';
    document.getElementById('dashboard').style.display = 'none';
}

function showSignupForm() {
    // Your code to show signup form
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('signupForm').style.display = 'block';
    document.getElementById('dashboard').style.display = 'none';
}

function showDashboard() {
    // Your code to show dashboard
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('signupForm').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';
    loadUserProfile();
}

function displayUserProfile(userData) {
    // Display user data in your dashboard
    document.getElementById('displayUsername').textContent = userData.username;
    document.getElementById('displayEmail').textContent = userData.email;
    document.getElementById('displayUserId').textContent = userData.userId;
    if (userData.createdAt) {
        document.getElementById('displayCreatedAt').textContent = new Date(userData.createdAt).toLocaleDateString();
    }
}

// Check if user is already logged in when page loads
window.addEventListener('DOMContentLoaded', () => {
    const token = localStorage.getItem('authToken');
    if (token) {
        showDashboard();
    } else {
        showLoginForm();
    }
});